rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Check if the user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Helper: Check if the user owns the layout
    function isLayoutOwner(layoutId) {
      return isAuth() &&
        get(/databases/$(database)/documents/layouts/$(layoutId)).data.owner == request.auth.token.email;
    }

    // Layouts collection
    match /layouts/{layoutId} {
      // Anyone authenticated can list layouts (filtered client-side by owner)
      allow read: if isAuth();
      // Only the owner can write their layout
      allow create: if isAuth() && request.resource.data.owner == request.auth.token.email;
      allow update, delete: if isLayoutOwner(layoutId);

      // Locos - only layout owner can read/write
      match /locos/{locoId} {
        allow read, write: if isLayoutOwner(layoutId);
      }

      // Throttles - layout owner can read/write
      match /throttles/{throttleId} {
        allow read, write: if isLayoutOwner(layoutId);
      }

      // Turnouts - layout owner can read/write
      match /turnouts/{turnoutId} {
        allow read: if isAuth();
        allow write: if isLayoutOwner(layoutId);
      }

      // Signals - layout owner can read/write
      match /signals/{signalId} {
        allow read: if isAuth();
        allow write: if isLayoutOwner(layoutId);
      }

      // Effects - guests can read effects with allowGuest=true
      match /effects/{effectId} {
        allow read: if isAuth();
        // Guests can update state on guest-allowed effects only
        allow update: if isAuth()
          && resource.data.allowGuest == true
          && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['state', 'timestamp']);
        // Full write for layout owner
        allow create, delete: if isLayoutOwner(layoutId);
        allow update: if isLayoutOwner(layoutId);
      }

      // Routes - layout owner can manage, authenticated can read
      match /routes/{routeId} {
        allow read: if isAuth();
        allow write: if isLayoutOwner(layoutId);
      }

      // Devices - layout owner only
      match /devices/{deviceId} {
        allow read: if isAuth();
        allow write: if isLayoutOwner(layoutId);
      }

      // Tags - layout owner only
      match /tags/{tagId} {
        allow read: if isAuth();
        allow write: if isLayoutOwner(layoutId);
      }
    }

    // Test effects collection (for sound testing)
    match /testEffects/{docId} {
      allow read, write: if isAuth();
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
